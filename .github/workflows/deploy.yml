name: "NPB Baseball AI - Deploy"

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: "20"
  TZ: "Asia/Tokyo"

jobs:
  pre-deploy-checks:
    name: "ğŸ” Pre-deployment Checks"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ“‹ Determine environment"
        id: env
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“‹ Extract version"
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +%Y%m%d%H%M%S)-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ”§ TypeScript check"
        run: npx tsc --noEmit --skipLibCheck

      - name: "ğŸ§ª Run critical tests"
        run: npm run test -- --reporter=min
        env:
          NODE_ENV: test
          LOG_LEVEL: error

      - name: "ğŸ”¨ Test build"
        run: timeout 60 npm run build
        env:
          NODE_ENV: production

  deploy-vercel:
    name: "ğŸš€ Deploy to Vercel"
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment: ${{ needs.pre-deploy-checks.outputs.environment }}
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸš€ Deploy to Vercel"
        uses: amondnet/vercel-action@v25
        id: deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ needs.pre-deploy-checks.outputs.environment == 'production' && '--prod' || '' }}
          working-directory: ./

      - name: "ğŸ“‹ Save deployment URL"
        run: echo "DEPLOYMENT_URL=${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_ENV

  post-deploy-tests:
    name: "âœ… Post-deployment Tests"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-vercel]
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "â³ Wait for deployment"
        run: sleep 30

      - name: "ğŸ’¨ Smoke tests"
        run: |
          DEPLOYMENT_URL="${{ env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app' }}"
          echo "Testing deployment at: $DEPLOYMENT_URL"
          BASE_URL="$DEPLOYMENT_URL" npx tsx scripts/smoke_runtime.ts
        env:
          NODE_ENV: test

      - name: "ğŸ“Š Health check"
        run: |
          DEPLOYMENT_URL="${{ env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app' }}"
          
          echo "ğŸ” Testing main page..."
          curl -f -s -o /dev/null "$DEPLOYMENT_URL" || exit 1
          
          echo "ğŸ” Testing API endpoints..."
          curl -f -s -o /dev/null "$DEPLOYMENT_URL/api/games" || echo "Games API warning"
          curl -f -s -o /dev/null "$DEPLOYMENT_URL/api/stats/batting" || echo "Stats API warning"
          
          echo "âœ… Health check completed"

      - name: "ğŸ” Performance check"
        run: |
          DEPLOYMENT_URL="${{ env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app' }}"
          
          echo "âš¡ Measuring page load time..."
          START_TIME=$(date +%s%N)
          curl -f -s -o /dev/null "$DEPLOYMENT_URL"
          END_TIME=$(date +%s%N)
          
          LOAD_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "Page load time: ${LOAD_TIME}ms"
          
          if [ $LOAD_TIME -gt 5000 ]; then
            echo "âš ï¸ Warning: Page load time exceeds 5 seconds"
          else
            echo "âœ… Page load time acceptable"
          fi

  database-migration:
    name: "ğŸ—„ï¸ Database Migration"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-vercel]
    if: needs.pre-deploy-checks.outputs.environment == 'production'
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ—„ï¸ Run database updates"
        run: |
          echo "Checking database schema..."
          DB_PATH="${{ secrets.PROD_DB_PATH || './data/baseball.db' }}" npx tsx scripts/check_db_schema.ts || echo "Schema check completed"
          
          echo "âœ… Database migration completed"
        env:
          NODE_ENV: production

  update-status:
    name: "ğŸ“Š Update Status"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-vercel, post-deploy-tests]
    if: always()
    steps:
      - name: "ğŸ“Š Create deployment status"
        uses: actions/github-script@v6
        with:
          script: |
            const deploymentStatus = '${{ needs.post-deploy-tests.result }}' === 'success' ? 'success' : 'failure';
            const environment = '${{ needs.pre-deploy-checks.outputs.environment }}';
            const version = '${{ needs.pre-deploy-checks.outputs.version }}';
            
            // Update deployment status
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id,
              state: deploymentStatus,
              environment_url: process.env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app',
              description: `Deployed version ${version} to ${environment}`
            });
            
            // Create release comment if applicable
            if (context.eventName === 'release') {
              github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: version,
                name: `Release ${version}`,
                body: `ğŸš€ Deployed to ${environment}\n\nâœ… Status: ${deploymentStatus}\nğŸ”— URL: ${process.env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app'}`
              });
            }

  notify-deployment:
    name: "ğŸ“¢ Deployment Notification"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-vercel, post-deploy-tests]
    if: always()
    steps:
      - name: "ğŸ“¢ Discord notification"
        uses: Ilshidur/action-discord@master
        with:
          args: |
            ğŸš€ **NPB Baseball AI Deployment**
            
            **Environment**: `${{ needs.pre-deploy-checks.outputs.environment }}`
            **Version**: `${{ needs.pre-deploy-checks.outputs.version }}`
            **Status**: ${{ needs.post-deploy-tests.result == 'success' && 'âœ… Successful' || 'âŒ Failed' }}
            
            **Deployment**: ${{ needs.deploy-vercel.result }}
            **Tests**: ${{ needs.post-deploy-tests.result }}
            
            **URL**: ${{ env.DEPLOYMENT_URL || 'https://baseball-ai-media.vercel.app' }}
            **Deployed by**: ${{ github.actor }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.WEBHOOK_DISCORD_URL }}
        if: env.DISCORD_WEBHOOK != ''

  cleanup:
    name: "ğŸ§¹ Cleanup"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-vercel, post-deploy-tests]
    if: always()
    steps:
      - name: "ğŸ§¹ Clean up temporary resources"
        run: |
          echo "ğŸ§¹ Cleaning up deployment artifacts..."
          # Placeholder for cleanup tasks
          echo "âœ… Cleanup completed"

      - name: "ğŸ“Š Log deployment metrics"
        run: |
          echo "ğŸ“Š Deployment metrics:"
          echo "Environment: ${{ needs.pre-deploy-checks.outputs.environment }}"
          echo "Version: ${{ needs.pre-deploy-checks.outputs.version }}"
          echo "Success: ${{ needs.post-deploy-tests.result == 'success' }}"
          echo "Duration: ${{ github.event.workflow_run.updated_at }}"