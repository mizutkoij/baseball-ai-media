name: Golden Sample Quality Gate
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  golden-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create reports directory
        run: mkdir -p .reports
        
      - name: Run golden sample validation
        run: |
          npm run test:golden -- --reporter=junit --outputFile=.reports/junit-golden.xml
          
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: golden-test-reports
          path: .reports/**
          retention-days: 30
          
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            try {
              // Try to read the test results
              const reportExists = fs.existsSync('.reports/junit-golden.xml');
              const testStatus = reportExists ? 'âœ… Golden Sample Validation: PASSED' : 'âŒ Golden Sample Validation: NO REPORT';
              
              const comment = `
            ## ğŸ” Golden Sample Quality Gate
            
            ${testStatus}
            
            **Quality Metrics:**
            - âœ… Player statistics validation (10 players)
            - âœ… Team performance validation (10 teams) 
            - âœ… Data consistency checks
            - âœ… Database schema compatibility
            
            **Test Coverage:**
            - Statistical range validation with sample size adjustments
            - Database failover testing (current â†” history)
            - Year-based data availability checks
            
            ${reportExists ? 'ğŸ“Š Detailed results available in workflow artifacts.' : 'âš ï¸  Report generation failed - check workflow logs.'}
            `;
            
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Failed to create PR comment:', error);
            }
            
      - name: Fail on test failure
        run: |
          if [ ! -f ".reports/junit-golden.xml" ]; then
            echo "âŒ Golden sample tests failed - no report generated"
            exit 1
          fi
          
          # Check for test failures in the XML report
          if grep -q 'failures="[1-9]' .reports/junit-golden.xml 2>/dev/null; then
            echo "âŒ Golden sample validation failed - check test output"
            exit 1
          fi
          
          echo "âœ… Golden sample validation passed"