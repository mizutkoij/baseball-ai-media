groups:
- name: npb_scraper_critical
  rules:
  # ğŸš¨ ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°é€£ç¶šå¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆ
  - alert: ScrapeFailureSpike
    expr: increase(npb_scraper_requests_total{status="error"}[15m]) > 3
    for: 5m
    labels:
      severity: page
      team: baseball-ai
      component: scraper
    annotations:
      summary: "NPB ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°é€£ç¶šå¤±æ•—"
      description: "éå»15åˆ†é–“ã§{{ $value }}å›ã®ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°å¤±æ•—ãŒç™ºç”Ÿã€‚ã‚½ãƒ¼ã‚¹éšœå®³ã¾ãŸã¯ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å¯èƒ½æ€§"
      runbook_url: "https://github.com/your-org/baseball-ai-media/blob/main/docs/runbook.md#scrape-failure-spike"
      discord_channel: "#baseball-alerts"

  # â° äºˆå‘Šå…ˆç™ºæ›´æ–°åœæ»ã‚¢ãƒ©ãƒ¼ãƒˆ  
  - alert: NoStartersWritten
    expr: (time() - max(scheduler_next_run_timestamp{job="starters"})) > 3600
    for: 10m
    labels:
      severity: warn
      team: baseball-ai
      component: scheduler
    annotations:
      summary: "äºˆå‘Šå…ˆç™ºãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒåœæ»"
      description: "å…ˆç™ºæŠ•æ‰‹æƒ…å ±ã®æ›´æ–°ãŒ{{ $value | humanizeDuration }}åœæ­¢ä¸­ã€‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ç•°å¸¸ã®å¯èƒ½æ€§"
      runbook_url: "https://github.com/your-org/baseball-ai-media/blob/main/docs/runbook.md#no-starters-written"

  # ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¨ãƒ©ãƒ¼ç‡é«˜ã‚¢ãƒ©ãƒ¼ãƒˆ
  - alert: DQErrorRateHigh  
    expr: |
      (
        increase(data_validation_total{result="error"}[30m]) 
        / 
        clamp_min(increase(npb_scraper_requests_total[30m]), 1)
      ) > 0.05
    for: 10m
    labels:
      severity: page
      team: baseball-ai
      component: data_quality
    annotations:
      summary: "ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¨ãƒ©ãƒ¼ç‡ãŒç•°å¸¸"
      description: "éå»30åˆ†ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã§{{ $value | humanizePercentage }}ã®ã‚¨ãƒ©ãƒ¼ç‡ã€‚ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ç ´æã®å¯èƒ½æ€§"
      runbook_url: "https://github.com/your-org/baseball-ai-media/blob/main/docs/runbook.md#dq-error-rate-high"

- name: npb_scraper_warning
  rules:
  # ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¢ãƒ©ãƒ¼ãƒˆ
  - alert: DataDiskSpaceLow
    expr: |
      (
        node_filesystem_avail_bytes{mountpoint="/data"} 
        / 
        node_filesystem_size_bytes{mountpoint="/data"}
      ) < 0.1
    for: 5m
    labels:
      severity: warn
      team: baseball-ai
      component: storage
    annotations:
      summary: "ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³"
      description: "ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ã®ç©ºãå®¹é‡ãŒ{{ $value | humanizePercentage }}ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¾ãŸã¯æ‹¡å¼µãŒå¿…è¦"
      runbook_url: "https://github.com/your-org/baseball-ai-media/blob/main/docs/runbook.md#data-disk-space-low"

  # ğŸ“¡ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒ¼ãƒãƒ¼ç•°å¸¸
  - alert: MetricsServerDown
    expr: up{job="metrics-server"} == 0
    for: 2m
    labels:
      severity: warn
      team: baseball-ai
      component: monitoring
    annotations:
      summary: "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒ¼ãƒãƒ¼ãƒ€ã‚¦ãƒ³"
      description: "Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒ¼ãƒãƒ¼ãŒ{{ $value | humanizeDuration }}å¿œç­”ãªã—"
      runbook_url: "https://github.com/your-org/baseball-ai-media/blob/main/docs/runbook.md#metrics-server-down"

  # ğŸ”„ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼é…å»¶è­¦å‘Š
  - alert: SchedulerLag
    expr: |
      (time() - scheduler_last_execution_timestamp) > 900
    for: 5m
    labels:
      severity: warn
      team: baseball-ai
      component: scheduler
    annotations:
      summary: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œé…å»¶"
      description: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒ{{ $value | humanizeDuration }}å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„"

- name: npb_business_logic
  rules:
  # âš¾ è©¦åˆå½“æ—¥ãªã®ã«ãƒ‡ãƒ¼ã‚¿ãªã—
  - alert: GameDayNoData
    expr: |
      (
        (day_of_week() >= 1 and day_of_week() <= 7) and
        (hour() >= 12 and hour() <= 23) and
        increase(canonical_records_written_total{kind="games"}[6h]) == 0
      )
    for: 30m
    labels:
      severity: warn
      team: baseball-ai
      component: business_logic
    annotations:
      summary: "è©¦åˆæ—¥ãªã®ã«ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãªã—"
      description: "å¹³æ—¥å¤œé–“æ™‚é–“å¸¯ãªã®ã«éå»6æ™‚é–“ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ãŒãªã„ã€‚NPBä¼‘é¤Šæ—¥ã¾ãŸã¯éšœå®³ã®å¯èƒ½æ€§"

  # ğŸ“ˆ ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°æˆåŠŸç‡ä½ä¸‹
  - alert: ScrapeSuccessRateDown
    expr: |
      (
        rate(npb_scraper_requests_total{status="success"}[1h])
        /
        rate(npb_scraper_requests_total[1h])
      ) < 0.8
    for: 15m
    labels:
      severity: warn
      team: baseball-ai
      component: scraper
    annotations:
      summary: "ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°æˆåŠŸç‡ä½ä¸‹"
      description: "éå»1æ™‚é–“ã®æˆåŠŸç‡ãŒ{{ $value | humanizePercentage }}ã«ä½ä¸‹"

- name: npb_performance
  rules:
  # âš¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ç•°å¸¸
  - alert: ScrapeLatencyHigh
    expr: |
      histogram_quantile(0.95, rate(npb_scraper_duration_seconds_bucket[10m])) > 30
    for: 10m
    labels:
      severity: warn
      team: baseball-ai
      component: performance
    annotations:
      summary: "ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°å¿œç­”æ™‚é–“ç•°å¸¸"
      description: "95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒ{{ $value }}ç§’ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã¾ãŸã¯ã‚½ãƒ¼ã‚¹å´è² è·ã®å¯èƒ½æ€§"

  # ğŸ”¥ é«˜CPUä½¿ç”¨ç‡
  - alert: HighCPUUsage
    expr: |
      rate(process_cpu_user_seconds_total[5m]) > 0.8
    for: 10m
    labels:
      severity: warn
      team: baseball-ai
      component: performance
    annotations:
      summary: "CPUä½¿ç”¨ç‡ç•°å¸¸"
      description: "CPUä½¿ç”¨ç‡ãŒ{{ $value | humanizePercentage }}ã§æ¨ç§»ä¸­"