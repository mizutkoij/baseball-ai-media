# Baseball AI Media - nginx configuration
# SSE最適化 + reverse proxy

upstream baseball_nextjs {
    server 127.0.0.1:3000;
    keepalive 32;
}

upstream baseball_live_api {
    server 127.0.0.1:8787;
    keepalive 16;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=web:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=sse:10m rate=5r/s;

server {
    listen 80;
    listen [::]:80;
    server_name 100.88.12.26;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy strict-origin-when-cross-origin;
    
    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2)$ {
        proxy_pass http://baseball_nextjs;
        proxy_cache_valid 200 1h;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
    
    # SSE streams - 특별 최적화
    location /live/ {
        # SSE Rate limiting
        limit_req zone=sse burst=10 nodelay;
        
        proxy_pass http://baseball_live_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE 핵심 설정
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 1h;
        proxy_send_timeout 1h;
        gzip off;  # SSE에는 압축 금지
        
        # Keep-alive 연결 유지
        proxy_set_header Connection "";
        proxy_http_version 1.1;
    }
    
    # API endpoints
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        
        # Next.js API 우선, live-api fallback
        try_files $uri @nextjs_api;
    }
    
    location @nextjs_api {
        proxy_pass http://baseball_nextjs;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API 응답 캐싱 (단기)
        proxy_cache_valid 200 30s;
        proxy_cache_key $uri$is_args$args;
    }
    
    # Health checks
    location /health {
        access_log off;
        proxy_pass http://baseball_live_api;
        proxy_read_timeout 5s;
        proxy_connect_timeout 3s;
    }
    
    # Metrics (prometheus)
    location /metrics {
        allow 127.0.0.1;
        allow 100.88.12.0/24;
        deny all;
        
        proxy_pass http://baseball_live_api;
        proxy_read_timeout 10s;
    }
    
    # Admin endpoints
    location /admin/ {
        # Basic auth or IP restriction
        allow 127.0.0.1;
        allow 100.88.12.0/24;
        deny all;
        
        proxy_pass http://baseball_live_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Default - Next.js web app
    location / {
        limit_req zone=web burst=15 nodelay;
        
        proxy_pass http://baseball_nextjs;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Next.js static 캐싱
        proxy_cache_valid 200 5m;
        proxy_cache_key $uri$is_args$args;
    }
}

# Global nginx tuning for SSE connections
events {
    worker_connections 8192;
    use epoll;
    multi_accept on;
}

http {
    # Worker process optimization
    worker_processes auto;
    worker_rlimit_nofile 65536;
    
    # Buffer optimization
    client_body_buffer_size 16K;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;
    client_max_body_size 8M;
    
    # Timeout optimization
    client_body_timeout 15;
    client_header_timeout 15;
    keepalive_timeout 65;
    send_timeout 15;
    
    # TCP optimization
    tcp_nopush on;
    tcp_nodelay on;
    
    # Gzip (default on, SSE locations에서 off)
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}