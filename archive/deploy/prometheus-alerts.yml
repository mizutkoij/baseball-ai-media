# NPB Live Prediction System - Prometheus Alerting Rules
# Place in: /etc/prometheus/rules/npb-live.yml

groups:
  - name: npb_live_system
    rules:
      # Service availability
      - alert: NPBLiveServiceDown
        expr: up{job="npb-live"} == 0
        for: 1m
        labels:
          severity: critical
          service: npb-live
        annotations:
          summary: "NPB Live API service is down"
          description: "NPB Live API service has been down for more than 1 minute"
          runbook_url: "https://docs.npb-live.local/runbook/service-down"

      - alert: NPBMetricsServiceDown
        expr: up{job="npb-metrics"} == 0
        for: 2m
        labels:
          severity: warning
          service: npb-metrics
        annotations:
          summary: "NPB Metrics service is down"
          description: "NPB Metrics collection service has been down for more than 2 minutes"

      # High error rates
      - alert: NPBLiveHighErrorRate
        expr: rate(http_requests_total{job="npb-live",status=~"5.."}[5m]) / rate(http_requests_total{job="npb-live"}[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "High error rate in NPB Live API"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      # Response time degradation
      - alert: NPBLiveSlowResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="npb-live"}[5m])) > 2.0
        for: 5m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live API response time degraded"
          description: "95th percentile response time is {{ $value }}s"

      # SSE connection management
      - alert: NPBLiveTooManySSEConnections
        expr: sse_connections_active > 100
        for: 2m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "High number of SSE connections"
          description: "{{ $value }} active SSE connections (threshold: 100)"

      - alert: NPBLiveSSEConnectionSpike
        expr: increase(sse_connections_active[5m]) > 50
        for: 1m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "SSE connection spike detected"
          description: "{{ $value }} new SSE connections in the last 5 minutes"

      # Data freshness
      - alert: NPBLiveStaleData
        expr: time() - data_last_update_timestamp > 300
        for: 1m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live data is stale"
          description: "Last data update was {{ $value | humanizeDuration }} ago"

      - alert: NPBLiveVeryStaleData
        expr: time() - data_last_update_timestamp > 600
        for: 30s
        labels:
          severity: critical
          service: npb-live
        annotations:
          summary: "NPB Live data is very stale"
          description: "Last data update was {{ $value | humanizeDuration }} ago"

      # System resources
      - alert: NPBLiveHighMemoryUsage
        expr: process_resident_memory_bytes{job="npb-live"} / 1024 / 1024 / 1024 > 0.8
        for: 5m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live service high memory usage"
          description: "Memory usage is {{ $value | humanize }}GB"

      - alert: NPBLiveHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="npb-live"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live service high CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }}"

      # Prediction quality
      - alert: NPBLivePredictionQualityDegraded
        expr: prediction_confidence_avg < 0.6
        for: 10m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live prediction quality degraded"
          description: "Average prediction confidence is {{ $value | humanizePercentage }}"

      - alert: NPBLiveHighVolatility
        expr: prediction_volatility_avg > 0.1
        for: 10m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live predictions showing high volatility"
          description: "Average prediction volatility is {{ $value | humanizePercentage }}"

  - name: npb_live_data_pipeline
    rules:
      # Game detection
      - alert: NPBLiveNoActiveGames
        expr: active_games_count == 0 and hour() >= 13 and hour() <= 21
        for: 30m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "No active NPB games detected"
          description: "No active games found during expected game hours (13:00-21:00 JST)"

      # File system issues
      - alert: NPBLiveDataDirectoryFull
        expr: disk_usage_percent{path="/opt/npb/data"} > 90
        for: 5m
        labels:
          severity: critical
          service: npb-live
        annotations:
          summary: "NPB Live data directory almost full"
          description: "Data directory usage is {{ $value | humanizePercentage }}"

      - alert: NPBLiveDataDirectoryIssue
        expr: disk_usage_percent{path="/opt/npb/data"} > 85
        for: 10m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live data directory usage high"
          description: "Data directory usage is {{ $value | humanizePercentage }}"

      # Processing delays
      - alert: NPBLiveProcessingDelay
        expr: processing_delay_seconds > 30
        for: 2m
        labels:
          severity: warning
          service: npb-live
        annotations:
          summary: "NPB Live processing delay detected"
          description: "Processing delay is {{ $value }}s"

      - alert: NPBLiveHighProcessingDelay
        expr: processing_delay_seconds > 60
        for: 1m
        labels:
          severity: critical
          service: npb-live
        annotations:
          summary: "NPB Live high processing delay"
          description: "Processing delay is {{ $value }}s (critical threshold)"